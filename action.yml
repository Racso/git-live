name: 'GitLive Sync'
description: 'Sync tagged releases from a private repository to a public LIVE repository'
branding:
  icon: 'git-branch'
  color: 'blue'

inputs:
  live-url:
    description: 'URL of the LIVE remote repository (e.g., https://github.com/user/repo.git). Can be omitted if GITLIVE_URL env var is set or gitlive.z0 config file contains the URL'
    required: false
    default: ''
  mode:
    description: 'Sync mode: incremental (default), repair, or nuke'
    required: false
    default: 'incremental'
  dry-run:
    description: 'Run in dry-run mode without pushing changes'
    required: false
    default: 'false'
  verbosity:
    description: 'Verbosity level: normal (default), verbose, or very-verbose'
    required: false
    default: 'normal'
  config-file:
    description: 'Path to gitlive config file (optional)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Build GitLive
      shell: bash
      run: |
        # Use the action path (where this action's repository files are available)
        cd "$GITHUB_ACTION_PATH"
        # Publish into the caller's workspace so subsequent steps can execute the binary
        dotnet publish GitLive.csproj -c Release -r linux-x64 -o "$GITHUB_WORKSPACE/gitlive-bin"
    
    - name: Run GitLive Sync
      shell: bash
      env:
        LIVE_URL: ${{ inputs.live-url }}
        MODE: ${{ inputs.mode }}
        DRY_RUN: ${{ inputs.dry-run }}
        VERBOSITY: ${{ inputs.verbosity }}
        CONFIG_FILE: ${{ inputs.config-file }}
      run: |
        # Prepare arguments
        ARGS=()
        
        # Add URL if provided
        if [ -n "$LIVE_URL" ]; then
          ARGS+=("--url=$LIVE_URL")
        fi
        
        # Add mode flag
        if [ "$MODE" = "repair" ]; then
          ARGS+=("--repair")
        elif [ "$MODE" = "nuke" ]; then
          ARGS+=("--nuke")
        else
          ARGS+=("--incremental")
        fi
        
        # Add dry-run flag
        if [ "$DRY_RUN" = "true" ]; then
          ARGS+=("--dry-run")
        fi
        
        # Add verbosity flag
        if [ "$VERBOSITY" = "verbose" ]; then
          ARGS+=("-v")
        elif [ "$VERBOSITY" = "very-verbose" ]; then
          ARGS+=("-vv")
        fi
        
        # Copy config file if provided (resolve path relative to the workflow workspace)
        if [ -n "$CONFIG_FILE" ] && [ -f "$CONFIG_FILE" ]; then
          cp "$CONFIG_FILE" "$GITHUB_WORKSPACE/gitlive"
        fi
        
        # Run GitLive (binary published into the workspace)
        "$GITHUB_WORKSPACE/gitlive-bin/git-live" "${ARGS[@]}"
    
    - name: Cleanup
      shell: bash
      if: always()
      run: |
        rm -rf "$GITHUB_WORKSPACE/gitlive-bin"
